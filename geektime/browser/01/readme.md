https://time.geekbang.org/column/article/113513

- 当打开浏览器时， 会发生什么？
  启动一个进程， 进程是分配资源的最小单元。
  pgrep -x "Google Chrome" 
  ps aux | grep -i "chrome" 
- 你觉得浏览器要负责哪些功能呢？
  - 网络流程  下载各种资源
  - 页面渲染过程  html/css/js  渲染成最终的页面
  - JavaScript 执行流程 v8 引擎  解析执行 js 代码
  - Web 安全理论  防止恶意攻击
  浏览器的多进程架构
  pgrep -f "Google Chrome"

- 打开![](1.png) 看到了什么？
  Chrome 浏览器右上角的“选项”菜单，选择“更多工具”子菜单，点击“任务管理器”
  Chrome 打开一个页面需要启动多少进程
  Chrome 任务管理器也是用来展示运行中 Chrome 使用的进程信息的
  多进程
  - 浏览器主进程
  - GPU 进程 
  - 实用程序 network 
  - Storage Service
  - Data Decoder Service 
  - 一个tab 一个标签页进程 （页面相互独立）

## 进程和线程
- 什么是并行处理
计算机中的并行处理就是同一时刻处理多个任务 

  - 请分析一下任务的执行
  ```
  A = 1+2
  B = 20/5
  C = 7*8
  console.log(A, B, C)
  ```
  在编写代码的时候，我们可以把这个过程拆分为四个任务：
  任务 1 是计算 A=1+2；
  任务 2 是计算 B=20/5；
  任务 3 是计算 C=7*8；
  任务 4 是显示最后计算的结果。

  正常情况下程序可以使用单线程来处理，也就是分四步按照顺序分别执行这四个任务。
  JS 就是单线程

  采用多线程？
  只需要两步 第一步，使用三个线程同时执行前三个任务；第二步，再执行第四个显示任务。
  使用并行处理能大大提升性能。

### 线程 VS 进程

多线程可以并行处理任务，但是线程是不能单独存在的，它是由进程来启动和管理的。

- 一个进程就是一个程序的运行实例。
启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放代码、运行中的数据和一个执行任务的主线程，我们把这样的一个运行环境叫进程。

![](https://static001.geekbang.org/resource/image/33/da/3380f0a16c323deda5d3a300804b95da.png?wh=1142*575)

线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率。

- 进程和线程之间的关系有以下 4 个特点。
  - 进程中的任意一线程执行出错，都会导致整个进程的崩溃。
  ```
  A = 1+2
  B = 20/0
  C = 7*8
  ```
  由于分母为 0，线程会执行出错，这样就会导致整个进程的崩溃，当然另外两个线程执行的结果也没有了。

- 线程之间共享进程中的数据。
  线程之间可以对进程的公共数据进行读写操作。
  ![](https://static001.geekbang.org/resource/image/d0/9e/d0efacd7f299ed99e776cb97da2a799e.png?wh=1142*789)

- 3. 当一个进程关闭之后，操作系统会回收进程所占用的内存。
- 4. 进程之间的内容相互隔离。
  进程隔离是为保护操作系统中进程互不干扰的技术，每一个进程只能访问自己占有的数据，也就避免出现进程 A 写入数据到进程 B 的情况。正是因为进程之间的数据是严格隔离的，所以一个进程如果崩溃了，或者挂起了，是不会影响到其他进程的。如果进程之间需要进行数据的通信，这时候，就需要使用用于进程间通信（IPC）的机制了。

## 单进程浏览器时代
单进程浏览器是指浏览器的所有功能模块都是运行在同一个进程里，这些模块包含了网络、插件、JavaScript 运行环境、渲染引擎和页面等。
2007 年之前，市面上浏览器都是单进程的。

![](https://static001.geekbang.org/resource/image/6d/ca/6ddad2419b049b0eb2a8036f3dfff1ca.png?wh=1142*469)

如此多的功能模块运行在一个进程里，是导致单进程浏览器不稳定、不流畅和不安全的一个主要因素。下面我就来一一分析下出现这些问题的原因。

问题 1：不稳定早期浏览器需要借助于插件来实现诸如 Web 视频、Web 游戏等各种强大的功能，但是插件是最容易出问题的模块，并且还运行在浏览器进程之中，所以一个插件的意外崩溃会引起整个浏览器的崩溃。

渲染引擎模块也是不稳定的，通常一些复杂的 JavaScript 代码就有可能引起渲染引擎模块的崩溃。和插件一样，渲染引擎的崩溃也会导致整个浏览器的崩溃。
A 页面会影响B页面

问题 2：不流畅

从上面的“单进程浏览器架构示意图”可以看出，所有页面的渲染模块、JavaScript 执行环境以及插件都是运行在同一个线程中的，这就意味着同一时刻只能有一个模块可以执行。

```
function freeze() {
  while (1) {
    console.log("freeze");
  }
}
freeze();
```

如果让这个脚本运行在一个单进程浏览器的页面里，你感觉会发生什么？

因为这个脚本是无限循环的，所以当其执行时，它会独占整个线程，这样导致其他运行在该线程中的模块就没有机会被执行。因为浏览器中所有的页面都运行在该线程中，所以这些页面都没有机会去执行任务，这样就会导致整个浏览器失去响应，变卡顿。

## 多进程浏览器时代
![](https://static001.geekbang.org/resource/image/b6/fc/b61cab529fa31301bde290813b4587fc.png?wh=1142*494)

最新的 Chrome 浏览器包括：1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程。

浏览器进程。主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。

渲染进程。核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。

GPU 进程。其实，Chrome 刚开始发布的时候是没有 GPU 进程的。而 GPU 的使用初衷是为了实现 3D CSS 的效果，只是随后网页、Chrome 的 UI 界面都选择采用 GPU 来绘制，这使得 GPU 成为浏览器普遍的需求。最后，Chrome 在其多进程架构上也引入了 GPU 进程。

网络进程。主要负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面的，直至最近才独立出来，成为一个单独的进程。

插件进程。主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

现在你应该就可以回答文章开头提到的问题了：仅仅打开了 1 个页面，为什么有 4 个进程？因为打开 1 个页面至少需要 1 个网络进程、1 个浏览器进程、1 个 GPU 进程以及 1 个渲染进程，共 4 个；如果打开的页面有运行插件的话，还需要再加上 1 个插件进程。


虽然多进程模型提升了浏览器的稳定性、流畅性和安全性，但同样不可避免地带来了一些问题：更高的资源占用。因为每个进程都会包含公共基础结构的副本（如 JavaScript 运行环境），这就意味着浏览器会消耗更多的内存资源。更复杂的体系架构。浏览器各模块之间耦合性高、扩展性差等问题，会导致现在的架构已经很难适应新的需求了。